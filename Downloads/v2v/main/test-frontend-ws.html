<!DOCTYPE html>
<html>

<head>
    <title>V2V Frontend WebSocket Test</title>
</head>

<body>
    <h1>V2V Frontend WebSocket Test</h1>
    <div id="log"></div>

    <script>
        const log = document.getElementById('log');

        function addLog(message) {
            const div = document.createElement('div');
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(div);
            console.log(message);
        }

        addLog('ğŸ”— Connecting to V2V WebSocket...');

        const ws = new WebSocket('ws://localhost:3002/v2v');

        ws.onopen = () => {
            addLog('âœ… Connected to V2V backend');

            // Register a test vehicle
            const testVehicle = {
                vehicleId: 'frontend-test-' + Date.now(),
                driverName: 'Frontend Test Driver',
                vehicleInfo: {
                    model: 'Test Browser Vehicle',
                    color: 'purple'
                }
            };

            ws.send(JSON.stringify({
                event: 'register',
                data: testVehicle
            }));

            addLog('ğŸ“¤ Sent registration: ' + testVehicle.vehicleId);
        };

        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                addLog(`ğŸ“¥ Received: ${msg.event} - ${JSON.stringify(msg.data || {})}`);

                if (msg.event === 'registered') {
                    addLog('âœ… Vehicle registered successfully');

                    // Send location update
                    setTimeout(() => {
                        const location = {
                            vehicleId: msg.data.vehicleId,
                            lat: 37.7749,
                            lon: -122.4194
                        };

                        ws.send(JSON.stringify({
                            event: 'location_update',
                            data: location
                        }));

                        addLog(`ğŸ“ Sent location: ${location.lat}, ${location.lon}`);
                    }, 500);
                }

                if (msg.event === 'nearby_vehicles') {
                    if (msg.data && msg.data.vehicles) {
                        addLog(`ğŸ¯ NEARBY VEHICLES: ${msg.data.vehicles.length} vehicles found`);
                        msg.data.vehicles.forEach(v => {
                            addLog(`   - ${v.vehicleId}: ${v.distance}m away (${v.driverName})`);
                        });
                    } else {
                        addLog(`ğŸ¯ NEARBY VEHICLES: No vehicles nearby`);
                    }
                }

            } catch (e) {
                addLog('âŒ Error parsing message: ' + e.message);
            }
        };

        ws.onerror = (error) => {
            addLog('âŒ WebSocket error: ' + error);
        };

        ws.onclose = (event) => {
            addLog(`ğŸ”Œ WebSocket closed: ${event.code} ${event.reason}`);
        };

        // Add button to test connection
        const button = document.createElement('button');
        button.textContent = 'Test Now';
        button.onclick = () => {
            if (ws.readyState === WebSocket.OPEN) {
                addLog('ğŸ”„ WebSocket is connected and ready');
            } else {
                addLog('âŒ WebSocket is not connected');
            }
        };
        document.body.appendChild(button);
    </script>
</body>

</html>