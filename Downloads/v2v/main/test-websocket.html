<!DOCTYPE html>
<html>

<head>
    <title>V2V WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }

        .button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }

        .status {
            padding: 5px 10px;
            margin: 5px;
            border-radius: 4px;
        }

        .connected {
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>
    <h1>V2V WebSocket Dashboard Test</h1>

    <div id="status" class="status disconnected">Disconnected</div>

    <button class="button" onclick="connect()">Connect</button>
    <button class="button" onclick="registerVehicle()">Register Vehicle</button>
    <button class="button" onclick="sendLocation()">Send Location</button>
    <button class="button" onclick="disconnect()">Disconnect</button>
    <button class="button" onclick="clearLog()">Clear Log</button>

    <div id="log" class="log"></div>

    <script>
        let ws = null;
        let vehicleId = 'dashboard-test-' + Date.now();
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(status) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = status;
            statusDiv.className = 'status ' + (status === 'Connected' ? 'connected' : 'disconnected');
        }
        
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('Already connected');
                return;
            }
            
            log('Connecting to ws://localhost:3002/v2v...');
            ws = new WebSocket('ws://localhost:3002/v2v');
            
            ws.onopen = function() {
                log('‚úÖ WebSocket connected successfully');
                updateStatus('Connected');
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    log('üì• Received: ' + JSON.stringify(data, null, 2));
                    
                    if (data.event === 'nearby_vehicles' && data.data && data.data.vehicles) {
                        log('üéØ NEARBY VEHICLES DETECTED: ' + data.data.vehicles.length + ' vehicles');
                        data.data.vehicles.forEach(v => {
                            log('  - ' + v.vehicleId + ': ' + v.distance + 'm away');
                        });
                    }
                } catch (e) {
                    log('üì• Received (raw): ' + event.data);
                }
            };
            
            ws.onclose = function(event) {
                log('‚ùå WebSocket closed: ' + event.code + ' ' + event.reason);
                updateStatus('Disconnected');
            };
            
            ws.onerror = function(error) {
                log('üí• WebSocket error: ' + error);
                updateStatus('Error');
            };
        }
        
        function registerVehicle() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå Not connected');
                return;
            }
            
            const message = {
                event: 'register',
                data: {
                    vehicleId: vehicleId,
                    driverName: 'Dashboard Test User',
                    vehicleInfo: {
                        model: 'Test Vehicle',
                        color: 'blue'
                    }
                }
            };
            
            log('üì§ Registering vehicle: ' + vehicleId);
            ws.send(JSON.stringify(message));
        }
        
        function sendLocation() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå Not connected');
                return;
            }
            
            // Random location near San Francisco
            const lat = 37.7749 + (Math.random() - 0.5) * 0.01;
            const lon = -122.4194 + (Math.random() - 0.5) * 0.01;
            
            const message = {
                event: 'location_update',
                data: {
                    vehicleId: vehicleId,
                    lat: lat,
                    lon: lon
                }
            };
            
            log('üìç Sending location: ' + lat.toFixed(6) + ', ' + lon.toFixed(6));
            ws.send(JSON.stringify(message));
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Auto-connect on page load
        connect();
    </script>
</body>

</html>